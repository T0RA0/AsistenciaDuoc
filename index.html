<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Asistencia - Quilicura</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .container {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    h2 {
      margin-bottom: 20px;
      color: #1f2937;
    }

    label {
      display: block;
      text-align: left;
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #1d4ed8;
    }

    #estado {
      margin-top: 20px;
      font-size: 14px;
      color: #111827;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Registro de Asistencia DUOC</h2>

    <form id="formulario">
      <label>Nombre:</label>
      <input type="text" id="nombre" required>

      <label>Correo institucional:</label>
      <input type="email" id="email" required>

      <button type="submit">Registrar Asistencia</button>
    </form>

    <p id="estado"></p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzD32NLxIKIMPTv6lHGYJt_qXvpMXHnqrgdrL6JlbqgjWu3eL5MB8xNrMktmAJeYveY/exec";
    const lat_ref = -33.35530;
    const lon_ref = -70.75161;

    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const rad = Math.PI / 180;
      const œÜ1 = lat1 * rad;
      const œÜ2 = lat2 * rad;
      const ŒîœÜ = (lat2 - lat1) * rad;
      const ŒîŒª = (lon2 - lon1) * rad;
      const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    document.getElementById("formulario").addEventListener("submit", async function(e) {
      e.preventDefault();

      const nombre = document.getElementById("nombre").value.trim();
      const email = document.getElementById("email").value.trim();
      const estado = document.getElementById("estado");
      estado.innerText = "üìç Verificando ubicaci√≥n...";

      // Verificaci√≥n de horario
      const ahora = new Date();
      const hora = ahora.getHours();
      const minutos = ahora.getMinutes();
      if (!(hora === 8 && minutos >= 30 || hora === 9 && minutos === 0)) {
        estado.innerText = "‚è∞ Fuera del horario permitido (8:30 - 9:00 AM)";
        return;
      }

      // Verificaci√≥n de correo
      if (!email.endsWith("@duocuc.cl")) {
        estado.innerText = "‚ùå El correo debe terminar en @duocuc.cl";
        return;
      }

      if (!navigator.geolocation) {
        estado.innerText = "‚ùå Tu navegador no soporta geolocalizaci√≥n.";
        return;
      }

      navigator.geolocation.getCurrentPosition(async position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const distancia = calcularDistancia(lat, lon, lat_ref, lon_ref);

        if (distancia <= 100) {
          estado.innerText = "‚úÖ Dentro del √°rea permitida. Registrando...";

          const formData = new FormData();
          formData.append("nombre", nombre);
          formData.append("email", email);
          formData.append("latitud", lat);
          formData.append("longitud", lon);
          formData.append("distancia", distancia.toFixed(2));

          try {
            const res = await fetch(scriptURL, {
              method: "POST",
              body: formData
            });

            const respuesta = await res.text();
            if (respuesta === "OK") {
              estado.innerText = `‚úÖ Usuario ${nombre} registrado en la asistencia.`;
            } else {
              estado.innerText = `‚ö†Ô∏è Respuesta inesperada: ${respuesta}`;
            }

          } catch (err) {
            estado.innerText = "‚ùå Error al enviar los datos.";
          }

        } else {
          estado.innerText = `‚ùå Est√°s fuera del rango permitido. Distancia: ${distancia.toFixed(2)} m`;
        }
      }, () => {
        estado.innerText = "‚ùå No se pudo obtener tu ubicaci√≥n.";
      });
    });
  </script>

</body>
</html>
